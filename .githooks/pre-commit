#!/bin/bash

# Pre-commit hook to fetch Google Places data
# This ensures the places data is always up to date before commits

set -e

echo "ğŸª Running pre-commit hook..."

# Check if we have the required API key
if [ -z "$BUILD_API_KEY" ]; then
    echo "âš ï¸  BUILD_API_KEY not set in environment."
    echo "ğŸ” Checking for places data file..."
    
    if [ -f "src/data/places-data.json" ]; then
        echo "âœ… Places data file exists, continuing with commit..."
    else
        echo "âŒ No places data file found!"
        echo "ğŸ’¡ Run 'npm run fetch-places-data' first, or set BUILD_API_KEY in your environment."
        exit 1
    fi
else
    echo "ğŸ”‘ BUILD_API_KEY found, fetching latest places data..."
    
    # Check if API server is reachable (for local development)
    if curl -s --connect-timeout 5 "${NEXT_PUBLIC_API_BASE_URL:-http://localhost:3002}/api/health" > /dev/null 2>&1; then
        echo "ğŸŒ API server is reachable, fetching fresh data..."
        npm run fetch-places-data || {
            echo "âš ï¸  Failed to fetch places data, but continuing with existing data..."
        }
    else
        echo "ğŸ”Œ API server not reachable, using existing places data..."
        
        if [ ! -f "src/data/places-data.json" ]; then
            echo "âŒ No places data file found and API server is unreachable!"
            echo "ğŸ’¡ Either start your API server or add existing places data to commit."
            exit 1
        fi
    fi
fi

# Check if places data file exists and stage it
if [ -f "src/data/places-data.json" ]; then
    echo "ğŸ“ Staging places data file..."
    git add src/data/places-data.json
    echo "âœ… Places data staged for commit"
else
    echo "âš ï¸  No places data file to stage"
fi

echo "ğŸ‰ Pre-commit hook completed successfully!"
exit 0